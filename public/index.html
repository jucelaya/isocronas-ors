<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IsoMapa 15/30 â€“ Accesibilidad a pie/bici</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Turf.js -->
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<style>
  html,body,#map { height:100%; margin:0; }
</style>
</head>
<body>

<div id="map"></div>

<script>
const map = L.map('map').setView([-12.0621, -77.0465], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19, attribution: '&copy; OpenStreetMap'
}).addTo(map);

map.on('click', (e) => runFromPoint(e.latlng));

async function runFromPoint(latlng){
  const mins = [5,10,15,30];
  const profile = "foot-walking";
  const iso = await getIsochrones(latlng, profile, mins);
  drawIsochrones(iso);
}

async function getIsochrones(latlng, profile, minutes){
  const ranges = minutes.map(m=>m*60);
  const body = { locations: [[latlng.lng, latlng.lat]], range: ranges, range_type: "time" };

  // Llamada al backend en la misma URL de tu dominio
  const res = await fetch(`/api/isochrones/${profile}`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  if(!res.ok) throw new Error('Error ORS Proxy: ' + res.status);
  const gj = await res.json();
  gj.features.sort((a,b)=>a.properties.value - b.properties.value);
  return gj;
}

function drawIsochrones(gj){
  const colors=['#1f77b4','#2ca02c','#ff7f0e','#d62728'];
  gj.features.forEach((f,i)=>{
    L.geoJSON(f,{ style: { color:colors[i], weight:2, fillOpacity:.35 } }).addTo(map);
  });
}
</script>
</body>
</html>
