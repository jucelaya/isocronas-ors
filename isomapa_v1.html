<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IsoMapa 15/30 ‚Äì Accesibilidad a pie/bici</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Turf.js -->
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<!-- Leaflet EasyPrint (export PNG) -->
<script src="https://unpkg.com/leaflet-easyprint@2.1.9/dist/bundle.min.js"></script>

<style>
  :root { --c1:#1f77b4; --c2:#2ca02c; --c3:#ff7f0e; --c4:#d62728; }
  html,body,#map { height:100%; margin:0; }
  .panel {
    position: absolute; z-index: 1000; top: 12px; left: 12px;
    background:#fff; padding:12px; border-radius:10px; box-shadow:0 8px 20px rgba(0,0,0,.15);
    max-width: 360px; font-family: system-ui, Arial, sans-serif;
  }
  .panel h2 { margin:0 0 8px; font-size:18px; color:#1d3557 }
  .row { display:flex; gap:8px; align-items:center; margin:6px 0 }
  select, input, button { font-size:14px; padding:6px 8px }
  button { background:#2563eb; color:#fff; border:0; border-radius:6px; cursor:pointer }
  button.secondary { background:#64748b }
  .note { font-size:12px; color:#475569; margin-top:4px }
  .status { margin-top:6px; font-size:13px; color:#0f172a }
  .warn { color:#b91c1c }
  table { width:100%; font-size:12px; border-collapse: collapse; margin-top:8px }
  th,td { border-bottom:1px solid #e2e8f0; padding:4px 6px; text-align:left }
  .legend { margin-top:6px; font-size:12px }
  .legend span { display:inline-block; width:12px; height:12px; border-radius:3px; margin-right:6px; vertical-align:middle }
  .footer-tools { display:flex; gap:6px; margin-top:8px }
  .link { color:#2563eb; text-decoration: none }
</style>
</head>
<body>

<div class="panel">
  <h2>IsoMapa 15/30</h2>
  <div class="row">
    <label>Modo:</label>
    <select id="modo">
      <option value="foot-walking">üö∂ A pie</option>
      <option value="cycling-regular">üö¥ En bici</option>
    </select>
  </div>
  <div class="row">
    <label>Tiempos (min):</label>
    <input id="t5" type="checkbox" checked>5
    <input id="t10" type="checkbox" checked>10
    <input id="t15" type="checkbox" checked>15
    <input id="t30" type="checkbox" checked>30
  </div>
  <div class="row">
    <button id="btnClick">üìç Click en el mapa</button>
    <button id="btnUbicacion" class="secondary">üéØ Usar mi ubicaci√≥n</button>
  </div>
  <div class="legend">
    <div><span style="background:rgba(31,119,180,.35);border:1px solid var(--c1)"></span>5 min</div>
    <div><span style="background:rgba(44,160,44,.35);border:1px solid var(--c2)"></span>10 min</div>
    <div><span style="background:rgba(255,127,14,.35);border:1px solid var(--c3)"></span>15 min</div>
    <div><span style="background:rgba(214,39,40,.35);border:1px solid var(--c4)"></span>30 min</div>
  </div>
  <div class="note">Categor√≠as OSM: escuelas, hospitales/clinicas, bancos, mercados y polic√≠a.</div>
  <div class="status" id="status">Tip: haz click en el mapa para generar isocronas.</div>

  <table id="tabla">
    <thead>
      <tr><th>Radio (min)</th><th>POI</th><th>Paraderos ATU</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="footer-tools">
    <button id="btnPng" class="secondary">üñºÔ∏è Exportar PNG</button>
    <button id="btnGeo" class="secondary">‚¨áÔ∏è Export GeoJSON</button>
  </div>
  <div class="note" style="margin-top:6px">
    ORS key requerida. <a href="https://openrouteservice.org/dev/#/signup" target="_blank" class="link">Obt√©n tu API Key</a>
  </div>
</div>

<div id="map"></div>

<script>
/* ===================== CONFIG ===================== */
const ORS_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjIwZmVmZmJlNjgxODQwZjE5OGU4MGMxM2JjY2U1OTczIiwiaCI6Im11cm11cjY0In0=';
const ATU_PARADEROS_URL = ''; // opcional

/* ===================== MAPA ===================== */
const map = L.map('map').setView([-12.0621, -77.0465], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19, attribution: '&copy; OpenStreetMap'
}).addTo(map);

let origenMarker = null;
const isochroneLayers = [];
let lastIsochronesGeoJSON = null;

// Botones
document.getElementById('btnClick').onclick = () => {
  map.once('click', (e) => runFromPoint(e.latlng));
};
document.getElementById('btnUbicacion').onclick = () => {
  map.locate({setView:true, maxZoom:15});
  map.once('locationfound', (e)=> runFromPoint(e.latlng));
};
document.getElementById('btnPng').onclick = () => {
  document.querySelector('.leaflet-control-easyPrint a').click();
};
document.getElementById('btnGeo').onclick = exportGeoJSON;

L.easyPrint({
  title: 'Exportar PNG',
  position: 'topleft',
  filename: 'isomapa',
  exportOnly: true
}).addTo(map);

async function runFromPoint(latlng){
  clearIsochrones();
  if(origenMarker) map.removeLayer(origenMarker);
  origenMarker = L.marker(latlng).addTo(map);

  const mins = [5,10,15,30];
  const iso = await getIsochrones(latlng, document.getElementById('modo').value, mins);
  lastIsochronesGeoJSON = iso;
  drawIsochrones(iso);
}

async function getIsochrones(latlng, profile, minutes){
  const ranges = minutes.map(m=>m*60);
  const body = {locations: [[latlng.lng, latlng.lat]], range: ranges, range_type: "time"};
  const res = await fetch(`https://api.openrouteservice.org/v2/isochrones/${profile}`,{
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization': ORS_API_KEY},
    body: JSON.stringify(body)
  });
  if(!res.ok) throw new Error('Error ORS: '+res.status);
  const gj = await res.json();
  gj.features.sort((a,b)=>a.properties.value - b.properties.value);
  return gj;
}

function drawIsochrones(gj){
  const colors=['#1f77b4','#2ca02c','#ff7f0e','#d62728'];
  gj.features.forEach((f,i)=>{
    const lay = L.geoJSON(f,{ style: { color:colors[i], weight:2, fillOpacity:.35 } }).addTo(map);
    isochroneLayers.push(lay);
  });
}

function clearIsochrones(){
  isochroneLayers.forEach(l=>map.removeLayer(l));
  isochroneLayers.length=0;
}

function exportGeoJSON(){
  if(!lastIsochronesGeoJSON){ alert('No hay datos'); return; }
  const blob = new Blob([JSON.stringify(lastIsochronesGeoJSON,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'isocronas.geojson'; a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
